<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0, user-scalable=no" />
<title>ìŠ¤í˜ì¸ì–´ RPG í•™ìŠµ ê²Œì„</title>

<!-- í™ˆ í™”ë©´ ì•„ì´ì½˜ -->
<link rel="apple-touch-icon" href="icon.png">

<!-- ì „ì²´í™”ë©´ ì›¹ì•± -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<style>
  :root{
    --accent:#ff4500;
    --bg:#f0f8ff;
    --card:#ffffff;
  }
  html,body{height:100%;margin:0;}
  body{
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background:var(--bg);
    padding:14px;
    color:#222;
    -webkit-font-smoothing:antialiased;
  }

  header{
    display:flex;
    align-items:center;
    gap:10px;
    margin-bottom:10px;
  }
  h1{font-size:18px;margin:0}
  p.subtitle{margin:0;color:#444;font-size:13px}

  .game{
    max-width:780px;
    margin:10px auto;
  }

  .chapter{
    background:var(--card);
    padding:12px;
    border-radius:12px;
    box-shadow:0 6px 18px rgba(0,0,0,0.06);
    margin-bottom:12px;
  }
  .chapter h2{margin:0 0 6px 0;color:var(--accent);font-size:16px}
  .problem{border:1px dashed #eee;padding:8px;border-radius:8px;margin-bottom:8px;background:linear-gradient(180deg, rgba(255,255,255,0.9), rgba(250,250,250,0.9))}
  .problem strong{display:block;margin-bottom:6px}
  .mission{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:6px 0;padding:6px;border-radius:8px}
  .mission button, .smallbtn{
    background:var(--accent); color:white; border:none;padding:6px 10px;border-radius:8px;font-size:13px;cursor:pointer;
    box-shadow:0 2px 6px rgba(0,0,0,0.08)
  }
  .mission button:hover{filter:brightness(.95)}
  input[type="text"]{padding:6px;border-radius:8px;border:1px solid #ddd;font-size:14px}
  .msg{margin-left:8px;font-size:14px}
  .success{color:green}
  .fail{color:#c0392b}

  footer{font-size:12px;color:#666;margin-top:12px;text-align:center}
  .note{font-size:12px;color:#555;margin-top:6px}
  @media (max-width:420px){
    body{padding:10px}
    .mission{flex-direction:column;align-items:flex-start}
    input[type="text"]{width:100%}
  }
</style>
</head>
<body>

<header>
  <div>
    <h1>ğŸ® ìŠ¤í˜ì¸ì–´ RPG â€” webapp</h1>
    <p class="subtitle">í™ˆ í™”ë©´ì— ì¶”ê°€í•´ì„œ ë°”ë¡œ í”Œë ˆì´í•˜ì„¸ìš” â€” ë°œìŒ(ğŸ”Š) ì§€ì›</p>
  </div>
</header>

<main class="game" id="game"></main>

<footer>
  <div>ë°œìŒì€ iPhone Safariì˜ SpeechSynthesisë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. (ì‚¬íŒŒë¦¬ ê¸°ì¤€ ìµœì )</div>
  <div class="note">ì˜ëª»í•˜ë©´ "ğŸ«¥ì‚¬ë¼ì§ˆê²Œìš”!"ê°€ ë‚˜ì˜¨ë‹¤ â€” ë¬´ì„œìš´ ì¹œêµ¬... ë†ë‹´ì´ì•¼.</div>
</footer>

<script>
/*
  ì „ì²´ êµ¬ì¡°:
  - 5 ì±•í„°, ì±•í„°ë‹¹ 5 ë¬¸ì œ, ë¬¸ì œë‹¹ 5 ë¯¸ì…˜(ì˜ˆì‹œ ë°ì´í„°)
  - ì‚¬ìš©ì ìš”ì²­ì— ë”°ë¼ ì˜¤ë‹µ/ì •ë‹µ ë©˜íŠ¸ ë¡œì§ ì¶”ê°€
*/

const praiseText = "ğŸ¤§ì•³ì¸„! ì˜í–ˆì–´ìš”!";
const firstWrongVariants = ["ğŸ¤«ì´ë²ˆì—” ë¹„ë°€ë¡œ í•´ì¤„ê²Œìš”!", "ğŸ˜…ë‹¤ìŒë¶€í„° ì˜í•´ ë´ìš”!"];
const repeatWrongText = "ğŸ«¥ì‚¬ë¼ì§ˆê²Œìš”!";

// ì‹œë„ íšŸìˆ˜ ì €ì¥: key -> attempts (ìˆ«ì)
const attempts = {}; // ex: attempts["0_1_2"] = 1

// ìƒ˜í”Œ ë°ì´í„°: 5ì±•í„° X 5ë¬¸ì œ X 5ë¯¸ì…˜ êµ¬ì„± (ë‚´ìš©ì€ ì˜ˆì‹œì´ë©° í™•ì¥ ê°€ëŠ¥)
const chapters = [
  {
    title: "Chapter 1: ì•„ì¹¨ ì¸ì‚¬",
    problems: [
      {
        question: "ê¸°ë³¸ ì¸ì‚¬",
        missions: [
          {type:"speak", text:"Â¡Hola, Marco!"},
          {type:"input", text:"'ì•ˆë…•'ì„ ìŠ¤í˜ì¸ì–´ë¡œ ì…ë ¥í•˜ì„¸ìš”", answer:"hola"},
          {type:"fill", text:"ì¹œêµ¬ ì´ë¦„ ë„£ì–´ ë¬¸ì¥ ì™„ì„±: Â¡Hola, {name}!", answer:"Â¡Hola, Marco!"},
          {type:"speak", text:"Â¿CÃ³mo estÃ¡s?"},
          {type:"choice", text:"'ì˜ ì§€ëƒˆì–´?'ì— ë§ëŠ” ë¬¸ì¥ì€?", options:["Â¿CÃ³mo estÃ¡s?","Hola","Gracias"], answer:"Â¿CÃ³mo estÃ¡s?"}
        ]
      },
      {
        question: "ìƒíƒœ ë¬»ê¸°",
        missions: [
          {type:"speak", text:"Estoy bien"},
          {type:"choice", text:"'ì•„ì£¼ ì¢‹ì•„'ì— ê°€ì¥ ê°€ê¹Œìš´ í‘œí˜„ì€?", options:["Muy bien","AdiÃ³s","Por favor"], answer:"Muy bien"},
          {type:"input", text:"'ì•„ì£¼ ì¢‹ì•„' ì…ë ¥ (ì†Œë¬¸ì í—ˆìš©)", answer:"muy bien"},
          {type:"speak", text:"Estoy feliz"},
          {type:"fill", text:"ë¬¸ì¥ ì™„ì„±: Muy ___", answer:"bien"}
        ]
      },
      {
        question: "ì‘ë³„ ì¸ì‚¬",
        missions: [
          {type:"speak", text:"Hasta luego"},
          {type:"input", text:"'ë‹¤ìŒì— ë´' ì…ë ¥", answer:"hasta luego"},
          {type:"fill", text:"ë¬¸ì¥ ì™„ì„±: Hasta ___", answer:"luego"},
          {type:"speak", text:"Nos vemos"},
          {type:"choice", text:"'ë‚˜ì¤‘ì— ë´'ì— ë§ëŠ” ë¬¸ì¥ì€?", options:["Nos vemos","Hola","AdiÃ³s"], answer:"Nos vemos"}
        ]
      },
      {
        question: "ì•„ì¹¨ ê°ì • ë¬»ê¸°",
        missions: [
          {type:"speak", text:"Â¿QuÃ© tal tu dÃ­a?"},
          {type:"input", text:"'ì˜¤ëŠ˜ ì–´ë•Œ?' ì…ë ¥", answer:"quÃ© tal tu dÃ­a"},
          {type:"fill", text:"ë¬¸ì¥ ì™„ì„±: Â¿QuÃ© ___ tu dÃ­a?", answer:"tal"},
          {type:"speak", text:"Bien, gracias"},
          {type:"choice", text:"'ì¢‹ì•„, ê³ ë§ˆì›Œ'ëŠ”?", options:["Bien, gracias","AdiÃ³s","Hola"], answer:"Bien, gracias"}
        ]
      },
      {
        question: "ì¸ì‚¬ ë³µìŠµ",
        missions:[
          {type:"speak", text:"Â¡Hola! Â¿QuÃ© tal?"},
          {type:"input", text:"'ì•ˆë…•, ì˜ì§€ëƒˆì–´?' ì…ë ¥", answer:"hola, quÃ© tal"},
          {type:"fill", text:"ë¬¸ì¥ ì™„ì„±: Â¡___! Â¿QuÃ© tal?", answer:"Hola"},
          {type:"speak", text:"Â¡Buenos dÃ­as!"},
          {type:"choice", text:"ì•„ì¹¨ì¸ì‚¬ë¡œ ë§ëŠ” í‘œí˜„ì€?", options:["Buenos dÃ­as","Buenas noches","Hasta luego"], answer:"Buenos dÃ­as"}
        ]
      }
    ]
  },

  {
    title: "Chapter 2: ì¹´í˜ ì£¼ë¬¸",
    problems: [
      {
        question:"ê¸°ë³¸ ì£¼ë¬¸",
        missions:[
          {type:"speak", text:"Quisiera un cafÃ© con leche, por favor."},
          {type:"input", text:"'~ì£¼ì„¸ìš”' í‘œí˜„ (Quisiera ì…ë ¥)", answer:"quisiera"},
          {type:"fill", text:"ë¬¸ì¥ ì™„ì„±: Quisiera un ___ con leche", answer:"cafÃ©"},
          {type:"speak", text:"Un cortado, por favor."},
          {type:"choice", text:"'ê°ì‚¬í•©ë‹ˆë‹¤'ëŠ”?", options:["Gracias","Por favor","Hola"], answer:"Gracias"}
        ]
      },
      {
        question:"ì‚¬ì´ì¦ˆ ë¬»ê¸°",
        missions:[
          {type:"speak", text:"Â¿QuÃ© tamaÃ±o quieres?"},
          {type:"choice", text:"ì‘ì€ ì‚¬ì´ì¦ˆëŠ”?", options:["PequeÃ±o","Grande","Medio"], answer:"PequeÃ±o"},
          {type:"input", text:"'ì¤‘ê°„' ìŠ¤í˜ì¸ì–´ ì…ë ¥", answer:"medio"},
          {type:"speak", text:"Para llevar, por favor."},
          {type:"fill", text:"ë¬¸ì¥ ì™„ì„±: Para ___, por favor.", answer:"llevar"}
        ]
      },
      {
        question:"ì¶”ê°€ ì£¼ë¬¸",
        missions:[
          {type:"speak", text:"Con azÃºcar, por favor."},
          {type:"input", text:"'ì„¤íƒ•' ìŠ¤í˜ì¸ì–´ ì…ë ¥", answer:"azÃºcar"},
          {type:"fill", text:"ë¬¸ì¥ ì™„ì„±: Con ___, por favor.", answer:"azÃºcar"},
          {type:"speak", text:"Sin leche, por favor."},
          {type:"choice", text:"'ìš°ìœ  ì—†ì´'ëŠ”?", options:["Sin leche","Con leche","Con azÃºcar"], answer:"Sin leche"}
        ]
      },
      {
        question:"ê²°ì œ",
        missions:[
          {type:"speak", text:"Â¿CuÃ¡nto es?"},
          {type:"input", text:"'ì–¼ë§ˆì˜ˆìš”?' ì…ë ¥", answer:"Â¿cuÃ¡nto es?"},
          {type:"fill", text:"ë¬¸ì¥ ì™„ì„±: Â¿___ es?", answer:"CuÃ¡nto"},
          {type:"speak", text:"Pago con tarjeta."},
          {type:"choice", text:"'ì¹´ë“œë¡œ ê²°ì œ'ëŠ”?", options:["Pago con tarjeta","Pago en efectivo","Gracias"], answer:"Pago con tarjeta"}
        ]
      },
      {
        question:"ë§ˆë¬´ë¦¬",
        missions:[
          {type:"speak", text:"Gracias, que tenga un buen dÃ­a."},
          {type:"input", text:"'ì¢‹ì€ í•˜ë£¨ ë³´ë‚´ì„¸ìš”' ì…ë ¥", answer:"que tenga un buen dÃ­a"},
          {type:"fill", text:"ë¬¸ì¥ ì™„ì„±: Que tenga un ___ dÃ­a.", answer:"buen"},
          {type:"speak", text:"Hasta luego"},
          {type:"choice", text:"'ì•ˆë…•'ì— í•´ë‹¹í•˜ëŠ” í‘œí˜„ì€?", options:["AdiÃ³s","Gracias","Hola"], answer:"AdiÃ³s"}
        ]
      }
    ]
  },

  {
    title:"Chapter 3: ê¸¸ ë¬»ê¸°",
    problems:[
      {
        question:"ì—­ ì°¾ê¸°",
        missions:[
          {type:"speak", text:"PerdÃ³n, Â¿dÃ³nde estÃ¡ la estaciÃ³n de metro?"},
          {type:"input", text:"'ì§€í•˜ì² ì—­ì€ ì–´ë””ì—ìš”?' ì…ë ¥", answer:"Â¿dÃ³nde estÃ¡ la estaciÃ³n de metro?"},
          {type:"fill", text:"ë¬¸ì¥ ì™„ì„±: Â¿DÃ³nde estÃ¡ la ___ de metro?", answer:"estaciÃ³n"},
          {type:"speak", text:"Siga recto y luego gire a la izquierda."},
          {type:"choice", text:"'ì™¼ìª½ìœ¼ë¡œ ë„ì„¸ìš”'ëŠ”?", options:["Gire a la izquierda","Siga recto","Suba las escaleras"], answer:"Gire a la izquierda"}
        ]
      },
      {
        question:"ê±°ë¦¬ ë¬¼ì–´ë³´ê¸°",
        missions:[
          {type:"speak", text:"Â¿EstÃ¡ lejos?"},
          {type:"choice", text:"'ë©€ì–´ìš”?'ì— í•´ë‹¹í•˜ëŠ” ë¬¸ì¥", options:["Â¿EstÃ¡ lejos?","Â¿DÃ³nde estÃ¡?","Â¿QuÃ© tal?"], answer:"Â¿EstÃ¡ lejos?"},
          {type:"input", text:"'ê°€ê¹Œì›Œìš”' ì…ë ¥", answer:"cerca"},
          {type:"speak", text:"EstÃ¡ a diez minutos caminando."},
          {type:"fill", text:"ë¬¸ì¥ ì™„ì„±: EstÃ¡ a ___ minutos caminando.", answer:"diez"}
        ]
      },
      {
        question:"ì¥ì†Œ í™•ì¸",
        missions:[
          {type:"speak", text:"Â¿DÃ³nde estÃ¡ el baÃ±o?"},
          {type:"input", text:"'í™”ì¥ì‹¤' ìŠ¤í˜ì¸ì–´ ì…ë ¥", answer:"el baÃ±o"},
          {type:"fill", text:"ë¬¸ì¥ ì™„ì„±: Â¿DÃ³nde estÃ¡ el ___?", answer:"baÃ±o"},
          {type:"speak", text:"Al fondo a la derecha."},
          {type:"choice", text:"'ì˜¤ë¥¸ìª½'ì€?", options:["Derecha","Izquierda","Recto"], answer:"Derecha"}
        ]
      },
      {
        question:"ëŒ€ì¤‘êµí†µ",
        missions:[
          {type:"speak", text:"Â¿DÃ³nde puedo comprar un billete?"},
          {type:"input", text:"'í‘œ' ìŠ¤í˜ì¸ì–´ ì…ë ¥", answer:"billete"},
          {type:"fill", text:"ë¬¸ì¥ ì™„ì„±: Â¿DÃ³nde puedo comprar un ___?", answer:"billete"},
          {type:"speak", text:"En la taquilla o la mÃ¡quina automÃ¡tica."},
          {type:"choice", text:"'ìë™íŒë§¤ê¸°'ëŠ”?", options:["La mÃ¡quina automÃ¡tica","La taquilla","El andÃ©n"], answer:"La mÃ¡quina automÃ¡tica"}
        ]
      },
      {
        question:"ë„ì›€ ìš”ì²­",
        missions:[
          {type:"speak", text:"Disculpe, Â¿me puede ayudar?"},
          {type:"input", text:"'ë„ì™€ì£¼ì‹¤ ìˆ˜ ìˆë‚˜ìš”?' ì…ë ¥", answer:"Â¿me puede ayudar?"},
          {type:"fill", text:"ë¬¸ì¥ ì™„ì„±: Disculpe, Â¿me puede ___?", answer:"ayudar"},
          {type:"speak", text:"Claro, dÃ­game."},
          {type:"choice", text:"'ë¬¼ì–´ë³´ë‹¤'ëŠ”?", options:["Preguntar","Ayudar","Salir"], answer:"Preguntar"}
        ]
      }
    ]
  },

  {
    title:"Chapter 4: ì‡¼í•‘",
    problems:[
      {
        question:"ê°€ê²© ë¬»ê¸°",
        missions:[
          {type:"speak", text:"Â¿CuÃ¡nto cuesta esta camiseta?"},
          {type:"input", text:"'ì´ ì…”ì¸  ì–¼ë§ˆì—ìš”?' ì…ë ¥", answer:"Â¿cuÃ¡nto cuesta esta camiseta?"},
          {type:"fill", text:"ë¬¸ì¥ ì™„ì„±: Â¿CuÃ¡nto ___ esta camiseta?", answer:"cuesta"},
          {type:"speak", text:"Son 20 euros."},
          {type:"choice", text:"'20ìœ ë¡œì…ë‹ˆë‹¤'ëŠ”?", options:["Son 20 euros","Es gratis","No estÃ¡ disponible"], answer:"Son 20 euros"}
        ]
      },
      {
        question:"ì‚¬ì´ì¦ˆ",
        missions:[
          {type:"speak", text:"Â¿Tiene otra talla?"},
          {type:"choice", text:"'ë‹¤ë¥¸ ì‚¬ì´ì¦ˆ ìˆë‚˜ìš”?'ëŠ”?", options:["Â¿Tiene otra talla?","Â¿Precio?","Â¿DÃ³nde estÃ¡?"], answer:"Â¿Tiene otra talla?"},
          {type:"input", text:"'ì‚¬ì´ì¦ˆ' ìŠ¤í˜ì¸ì–´ ì…ë ¥", answer:"talla"},
          {type:"speak", text:"Solo queda la M."},
          {type:"fill", text:"ë¬¸ì¥ ì™„ì„±: Solo queda la ___", answer:"M"}
        ]
      },
      {
        question:"í™˜ë¶ˆ/êµí™˜",
        missions:[
          {type:"speak", text:"Quisiera cambiar esto, por favor."},
          {type:"input", text:"'êµí™˜í•˜ê³  ì‹¶ì–´ìš”' ì…ë ¥", answer:"quisiera cambiar esto"},
          {type:"fill", text:"ë¬¸ì¥ ì™„ì„±: Quisiera ___ esto, por favor.", answer:"cambiar"},
          {type:"speak", text:"Â¿Tiene el recibo?"},
          {type:"choice", text:"'ì˜ìˆ˜ì¦'ì€?", options:["Recibo","Factura","Pago"], answer:"Recibo"}
        ]
      },
      {
        question:"ê²°ì œ ë°©ë²•",
        missions:[
          {type:"speak", text:"Â¿Aceptan tarjeta?"},
          {type:"choice", text:"'ì¹´ë“œ ë°›ë‚˜ìš”?'ëŠ”?", options:["Â¿Aceptan tarjeta?","Â¿Aceptan efectivo?","Â¿Aceptan cheques?"], answer:"Â¿Aceptan tarjeta?"},
          {type:"input", text:"'í˜„ê¸ˆ' ì…ë ¥", answer:"efectivo"},
          {type:"speak", text:"Solo efectivo, lo siento."},
          {type:"fill", text:"ë¬¸ì¥ ì™„ì„±: Solo ___, lo siento.", answer:"efectivo"}
        ]
      },
      {
        question:"ì˜ìˆ˜ì¦ ìš”ì²­",
        missions:[
          {type:"speak", text:"Â¿Me puede dar el recibo, por favor?"},
          {type:"input", text:"'ì˜ìˆ˜ì¦ ì£¼ì„¸ìš”' ì…ë ¥", answer:"me puede dar el recibo, por favor"},
          {type:"fill", text:"ë¬¸ì¥ ì™„ì„±: Â¿Me puede dar el ___?", answer:"recibo"},
          {type:"speak", text:"Claro, aquÃ­ tiene."},
          {type:"choice", text:"'ì—¬ê¸° ìˆìŠµë‹ˆë‹¤'ëŠ”?", options:["AquÃ­ tiene","Lo siento","Gracias"], answer:"AquÃ­ tiene"}
        ]
      }
    ]
  },

  {
    title:"Chapter 5: ì¹œêµ¬ì™€ ì•½ì†",
    problems:[
      {
        question:"ì˜í™” ì•½ì†",
        missions:[
          {type:"speak", text:"Â¿Quieres ir al cine este sÃ¡bado?"},
          {type:"choice", text:"'ì£¼ë§ì—'ëŠ”?", options:["Este sÃ¡bado","Ayer","MaÃ±ana"], answer:"Este sÃ¡bado"},
          {type:"input", text:"'ëª‡ ì‹œì—?' ì…ë ¥ (A las 5 ì˜ˆì‹œ)", answer:"a las 5"},
          {type:"speak", text:"A las 5 de la tarde."},
          {type:"fill", text:"ë¬¸ì¥ ì™„ì„±: A las ___ de la tarde.", answer:"5"}
        ]
      },
      {
        question:"ì‹ì‚¬ ì•½ì†",
        missions:[
          {type:"speak", text:"Â¿Quedamos para cenar maÃ±ana?"},
          {type:"input", text:"'ë‚´ì¼' ìŠ¤í˜ì¸ì–´ ì…ë ¥", answer:"maÃ±ana"},
          {type:"choice", text:"'ì €ë…ì‹ì‚¬'ëŠ”?", options:["Cenar","Almorzar","Desayunar"], answer:"Cenar"},
          {type:"fill", text:"ë¬¸ì¥ ì™„ì„±: Â¿Quedamos para ___ maÃ±ana?", answer:"cenar"},
          {type:"speak", text:"Perfecto, a las 8."}
        ]
      },
      {
        question:"ì‹œê°„ ì¡°ì •",
        missions:[
          {type:"speak", text:"Â¿A quÃ© hora nos vemos?"},
          {type:"input", text:"'ëª‡ ì‹œì— ë§Œë‚ ê¹Œ?' ì…ë ¥", answer:"Â¿a quÃ© hora nos vemos?"},
          {type:"fill", text:"ë¬¸ì¥ ì™„ì„±: Â¿A quÃ© ___ nos vemos?", answer:"hora"},
          {type:"choice", text:"'ì˜¤í›„ 3ì‹œ'ëŠ”?", options:["A las 3 de la tarde","A la medianoche","A las 3 de la maÃ±ana"], answer:"A las 3 de la tarde"},
          {type:"speak", text:"Nos vemos a las 3."}
        ]
      },
      {
        question:"ì•½ì† í™•ì¸",
        missions:[
          {type:"speak", text:"Â¿Sigues libre el sÃ¡bado?"},
          {type:"input", text:"'ì•„ì§ ì‹œê°„ ìˆì–´?' ì…ë ¥", answer:"sigues libre"},
          {type:"fill", text:"ë¬¸ì¥ ì™„ì„±: Â¿Sigues ___ el sÃ¡bado?", answer:"libre"},
          {type:"choice", text:"'ì‘, ê´œì°®ì•„'ëŠ”?", options:["SÃ­, puedo","No, gracias","QuizÃ¡s"], answer:"SÃ­, puedo"},
          {type:"speak", text:"Perfecto, nos vemos entonces."}
        ]
      },
      {
        question:"ì•½ì† ì·¨ì†Œ",
        missions:[
          {type:"speak", text:"Lo siento, no puedo venir."},
          {type:"input", text:"'ë¯¸ì•ˆí•´, ëª»ê°ˆ ê²ƒ ê°™ì•„' ì…ë ¥", answer:"lo siento, no puedo venir"},
          {type:"fill", text:"ë¬¸ì¥ ì™„ì„±: Lo siento, no puedo ___", answer:"venir"},
          {type:"choice", text:"'ë¯¸ì•ˆí•´'ëŠ”?", options:["Lo siento","Por favor","Gracias"], answer:"Lo siento"},
          {type:"speak", text:"Otra vez serÃ¡."}
        ]
      }
    ]
  }
];

// ê¸°ë³¸ speak(ë°œìŒ) í•¨ìˆ˜ â€” Safari/iOSì—ì„œ ë™ì‘
function speak(text){
  try{
    const u = new SpeechSynthesisUtterance(text);
    u.lang = 'es-ES';
    u.rate = 0.95;
    u.pitch = 1.0;
    speechSynthesis.speak(u);
  }catch(e){
    console.warn('Speech synthesis not available', e);
  }
}

// ë©”ì‹œì§€ ë¡œì§: id ê¸°ë°˜ìœ¼ë¡œ attempts ì¦ê°€/íŒë³„
function handleWrongMessage(id){
  attempts[id] = (attempts[id] || 0) + 1;
  if(attempts[id] === 1){
    // ì²«ë²ˆì§¸ í‹€ë¦¼: ë¬´ì‘ìœ„ë¡œ ë‘ ë¬¸êµ¬ ì¤‘ í•˜ë‚˜
    const pick = firstWrongVariants[Math.floor(Math.random()*firstWrongVariants.length)];
    return pick;
  } else {
    // ë‘ë²ˆì§¸ ì´ìƒ í‹€ë¦¼: ìµœì¢… ë©˜íŠ¸
    return repeatWrongText;
  }
}

function handleCorrectMessage(id){
  // ì •ë‹µì´ë©´ ì‹œë„ìˆ˜ ì´ˆê¸°í™”(ì„ íƒì‚¬í•­) ë˜ëŠ” ìœ ì§€. ì—¬ê¸°ì„  ì´ˆê¸°í™”.
  attempts[id] = 0;
  return praiseText;
}

// ì²´í¬ í—¬í¼: inputê³¼ fillì€ ë™ì¼ ë¡œì§ ì‚¬ìš©
function checkAnswerRaw(user, answer){
  if(!user && !answer) return false;
  // normalize: ì†Œë¬¸ì, ê³µë°± ì²˜ë¦¬, ì‘ì€/í° ë”°ì˜´í‘œ ì œê±°
  const norm = (s)=> s.toString().trim().toLowerCase()
    .replace(/[Â¡Â¿]/g,'')
    .replace(/\s+/g,' ')
    .normalize('NFC');
  return norm(user) === norm(answer);
}

// DOM ìƒì„±
function createGame(){
  const container = document.getElementById('game');
  chapters.forEach((chapter, ci)=>{
    const chap = document.createElement('section');
    chap.className = 'chapter';
    chap.innerHTML = `<h2>${chapter.title}</h2>`;
    chapter.problems.forEach((problem, pi)=>{
      const prob = document.createElement('div');
      prob.className = 'problem';
      prob.innerHTML = `<strong>ë¬¸ì œ ${pi+1}: ${problem.question}</strong>`;
      problem.missions.forEach((mission, mi)=>{
        const id = `${ci}_${pi}_${mi}`; // ê³ ìœ  id
        const mis = document.createElement('div');
        mis.className = 'mission';

        if(mission.type === 'speak'){
          mis.innerHTML = `<div style="flex:1">${mission.text}</div><div><button onclick="speak('${escapeForJs(mission.text)}')">ğŸ”Š ë°œìŒ ë“£ê¸°</button></div>`;
        }
        else if(mission.type === 'input'){
          mis.innerHTML = `<div style="flex:1">${mission.text}</div>
            <div style="display:flex;gap:8px;align-items:center">
              <input type="text" id="input_${id}" placeholder="ì…ë ¥...">
              <button onclick="onCheckInput('${id}','${escapeForJs(mission.answer)}')">í™•ì¸</button>
              <span class="msg" id="msg_${id}"></span>
            </div>`;
        }
        else if(mission.type === 'fill'){
          // show template if any
          mis.innerHTML = `<div style="flex:1">${mission.text}</div>
            <div style="display:flex;gap:8px;align-items:center">
              <input type="text" id="fill_${id}" placeholder="ì™„ì„±...">
              <button onclick="onCheckInput('fill_${id}','${escapeForJs(mission.answer)}')">í™•ì¸</button>
              <span class="msg" id="msg_fill_${id}"></span>
            </div>`;
        }
        else if(mission.type === 'choice'){
          const wrapper = document.createElement('div');
          wrapper.style.display = 'flex';
          wrapper.style.flexDirection = 'column';
          wrapper.style.gap = '6px';
          const txt = document.createElement('div');
          txt.textContent = mission.text;
          wrapper.appendChild(txt);
          const opts = document.createElement('div');
          opts.style.display='flex';
          opts.style.flexWrap='wrap';
          opts.style.gap='6px';
          mission.options.forEach(opt=>{
            const b = document.createElement('button');
            b.className = 'smallbtn';
            b.textContent = opt;
            b.onclick = ()=> onCheckChoice(id, opt, mission.answer);
            opts.appendChild(b);
          });
          const msgspan = document.createElement('span'); msgspan.id = `msg_${id}`; msgspan.className='msg';
          wrapper.appendChild(opts);
          wrapper.appendChild(msgspan);
          mis.appendChild(wrapper);
        }
        else {
          mis.textContent = mission.text || '';
        }

        prob.appendChild(mis);
      });

      chap.appendChild(prob);
    });

    container.appendChild(chap);
  });
}

// ì…ë ¥ í™•ì¸ ì´ë²¤íŠ¸
function onCheckInput(id, answer){
  // id may be 'fill_0_1_2' or '0_1_2'
  const el = document.getElementById(id) || document.getElementById('input_'+id) || document.getElementById(id.replace(/^fill_/,''));
  // Try common ids
  const inputEl = document.getElementById(id) || document.getElementById('input_'+id) || document.getElementById(id) || document.getElementById('fill_'+id) || document.getElementById(id.replace(/^fill_/,''));
  // More robust:
  const possible = [
    document.getElementById(id),
    document.getElementById('input_'+id),
    document.getElementById('fill_'+id),
    document.getElementById(id.replace(/^fill_/,'')),
  ];
  let input = null;
  for(const p of possible) if(p){ input = p; break; }
  if(!input) return;

  const user = input.value || '';
  const msgId = id.startsWith('fill_') ? `msg_${id}` : `msg_${id}`;
  const msgEl = document.getElementById(msgId) || document.getElementById(`msg_${id}`) || document.getElementById(`msg_fill_${id}`);

  const ok = checkAnswerRaw(user, answer);
  if(ok){
    if(msgEl){
      msgEl.textContent = handleCorrectMessage(id);
      msgEl.className = 'msg success';
    }
  } else {
    const text = handleWrongMessage(id);
    if(msgEl){
      msgEl.textContent = text;
      msgEl.className = 'msg fail';
    }
  }
}

// ì„ íƒì§€ í™•ì¸
function onCheckChoice(id, selected, answer){
  const msgEl = document.getElementById(`msg_${id}`);
  const ok = checkAnswerRaw(selected, answer);
  if(ok){
    msgEl.textContent = handleCorrectMessage(id);
    msgEl.className = 'msg success';
  } else {
    const text = handleWrongMessage(id);
    msgEl.textContent = text;
    msgEl.className = 'msg fail';
  }
}

// ì‘ì€ ì•ˆì „ í•¨ìˆ˜: ë”°ì˜´í‘œ ë“± í…ìŠ¤íŠ¸ ì´ìŠ¤ì¼€ì´í”„
function escapeForJs(s){
  if(!s) return '';
  return s.replace(/'/g,"\\'").replace(/"/g,'&quot;').replace(/\n/g,' ');
}

// init
createGame();

// ë…¸íŠ¸: í•„ìš”í•˜ë©´ attemptsë¥¼ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— ì €ì¥í•´ ë‹¤ìŒ ì„¸ì…˜ì—ë„ ìœ ì§€í•˜ê²Œ í•  ìˆ˜ ìˆìŒ.
// ì˜ˆ: localStorage.setItem('rpg_attempts', JSON.stringify(attempts))
</script>

</body>
</html>
